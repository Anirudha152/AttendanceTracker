<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Management Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.8.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.8.0/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Attendance Portal</a>
            <div class="navbar-text text-light d-none" id="lastUpdatedInfo">
                Last Updated: <span id="lastUpdatedTime"></span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Select User</h5>
            </div>
            <div class="card-body">
                <select id="userSelect" class="form-select mb-3">
                    <option value="">Select Entry Number</option>
                </select>
                <div id="userInfo" class="alert alert-info d-none">
                    Name: <span id="userName"></span><br>
                    Courses: <span id="userCourses"></span>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Actions</h5>
            </div>
            <div class="card-body">
                <div class="btn-group w-100 mb-3" role="group">
                    <input type="radio" class="btn-check" name="action" id="markAttendance" value="markAttendance" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="markAttendance">Mark Attendance</label>
                    <input type="radio" class="btn-check" name="action" id="tagClass" value="tagClass" autocomplete="off">
                    <label class="btn btn-outline-primary" for="tagClass">Tag Class</label>
                    <input type="radio" class="btn-check" name="action" id="viewAttendance" value="viewAttendance" autocomplete="off">
                    <label class="btn btn-outline-primary" for="viewAttendance">View Attendance</label>
                </div>
            </div>
        </div>

        <div id="markAttendanceForm" class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Mark Attendance</h5>
            </div>
            <div class="card-body">
                <form id="attendanceForm">
                    <div class="mb-3">
                        <label class="form-label">Course</label>
                        <select id="attendanceCourse" class="form-select" required>
                            <option value="">Select Course</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" id="attendanceDate" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Time Slot</label>
                        <div class="input-group">
                            <input type="time" id="startTime" class="form-control" step="1800" required>
                            <span class="input-group-text">to</span>
                            <input type="time" id="endTime" class="form-control" step="1800" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Attendance Type</label>
                        <select id="attendanceType" class="form-select" required>
                            <option value="true">True</option>
                            <option value="proxy">Proxy</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Mark Attendance</button>
                </form>
            </div>
        </div>

        <div id="tagClassForm" class="card mb-4 d-none">
            <div class="card-header">
                <h5 class="mb-0">Tag Class</h5>
            </div>
            <div class="card-body">
                <form id="tagForm">
                    <div class="mb-3">
                        <label class="form-label">Course</label>
                        <select id="tagCourse" class="form-select" required>
                            <option value="">Select Course</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" id="tagDate" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Time Slot</label>
                        <div class="input-group">
                            <input type="time" id="tagStartTime" class="form-control" step="1800" required>
                            <span class="input-group-text">to</span>
                            <input type="time" id="tagEndTime" class="form-control" step="1800" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tag</label>
                        <select id="tagType" class="form-select" required>
                            <option value="normal">Normal</option>
                            <option value="extra">Extra Class</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="attendance_not_taken">Attendance Not Taken</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div id="remarkDiv" class="mb-3 d-none">
                        <label class="form-label">Remark</label>
                        <input type="text" id="remark" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary">Tag Class</button>
                </form>
            </div>
        </div>

        <div id="viewAttendanceForm" class="card mb-4 d-none">
            <div class="card-header">
                <h5 class="mb-0">View Attendance</h5>
            </div>
            <div class="card-body">
                <form id="viewForm">
                    <div class="mb-3">
                        <label class="form-label">Course</label>
                        <select id="viewCourse" class="form-select" required>
                            <option value="">Select Course</option>
                        </select>
                    </div>
                </form>
                <!-- Add canvas for pie chart -->
                <div class="container d-none" id="pie_container">
                    <div class="row justify-content-center">
                        <div class="col-md-3 mb-0">
                            <div class="card" style="border-width: 0 !important;">
                                <div class="card-body" >
                                    <canvas id="attendanceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="attendanceResults" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            databaseURL: 'https://ai-club-343bb.firebaseio.com/'
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        async function isAttendanceAllowed(date, courseCode, timeSlot) {
            try {
                const classRef = database.ref(`classes/${date}/${courseCode}/${timeSlot}`);
                const snapshot = await classRef.once('value');
                const classData = snapshot.val();

                if (!classData) return true; // If no class data exists, allow attendance

                // Don't allow attendance if class is cancelled or marked as attendance not taken
                return !(classData.tag === 'cancelled' || classData.tag === 'attendance_not_taken');
            } catch (error) {
                console.error('Error checking attendance permission:', error);
                return false;
            }
        }

        async function removeExistingAttendance(date, courseCode, timeSlot) {
            try {
                const attendancePath = `attendance/${date}/${courseCode}/${timeSlot}`;
                await database.ref(attendancePath).remove();
                console.log('Existing attendance removed');
            } catch (error) {
                console.error('Error removing existing attendance:', error);
            }
        }

        function getCurrentTime() {
            const now = new Date();
            const istOptions = { timeZone: 'Asia/Kolkata', hour12: false };
            const [hours, minutes] = new Intl.DateTimeFormat('en-US', {
                ...istOptions,
                hour: '2-digit',
                minute: '2-digit'
            }).format(now).split(':');
            return `${hours}:${minutes}`;
        }

        function getCurrentDay() {
            const istDate = new Intl.DateTimeFormat('en-US', {
                timeZone: 'Asia/Kolkata',
                weekday: 'long'
            }).format(new Date());

            const days = {
                'Sunday': 0,
                'Monday': 1,
                'Tuesday': 2,
                'Wednesday': 3,
                'Thursday': 4,
                'Friday': 5,
                'Saturday': 6
            };

            return days[istDate];
        }

        async function findRelevantCourse(entryNumber) {
            if (!entryNumber) return null;

            const currentTime = getCurrentTime();
            const currentDay = getCurrentDay();
            const currentDate = new Date().toISOString().split('T')[0];

            try {
                const [coursesSnapshot, userSnapshot, classesSnapshot] = await Promise.all([
                    database.ref('courses').once('value'),
                    database.ref(`users/${entryNumber}`).once('value'),
                    database.ref(`classes/${currentDate}`).once('value')
                ]);

                const courses = coursesSnapshot.val();
                const userData = userSnapshot.val();
                const todayClasses = classesSnapshot.val();

                if (!userData || !userData.registered_courses) return null;

                let relevantClasses = [];

                // Check scheduled courses
                if (courses) {
                    relevantClasses = Object.entries(courses)
                        .filter(([code]) => userData.registered_courses.includes(code))
                        .flatMap(([code, course]) => {
                            const todaySchedules = course.schedule.filter(s => s.day === currentDay);
                            return todaySchedules.map(schedule => ({
                                code,
                                name: course.name,
                                startTime: schedule.startTime,
                                endTime: schedule.endTime,
                                room: schedule.room || course.room,
                                type: 'scheduled'
                            }));
                        });
                }

                // Check tagged classes
                if (todayClasses) {
                    Object.entries(todayClasses).forEach(([code, slots]) => {
                        if (userData.registered_courses.includes(code)) {
                            Object.entries(slots).forEach(([timeSlot, classInfo]) => {
                                if (classInfo.tag !== 'cancelled') {
                                    const [startTime, endTime] = timeSlot.split('-');
                                    relevantClasses.push({
                                        code,
                                        startTime,
                                        endTime,
                                        type: 'tagged',
                                        tag: classInfo.tag
                                    });
                                }
                            });
                        }
                    });
                }

                // Sort by start time
                relevantClasses.sort((a, b) => a.startTime.localeCompare(b.startTime));

                // Find current or next class
                const currentClass = relevantClasses.find(course =>
                    currentTime >= course.startTime && currentTime <= course.endTime
                );

                if (currentClass) {
                    return {
                        code: currentClass.code,
                        startTime: currentClass.startTime,
                        endTime: currentClass.endTime
                    };
                }

                const nextClass = relevantClasses.find(course =>
                    currentTime < course.startTime
                );

                return nextClass ? {
                    code: nextClass.code,
                    startTime: nextClass.startTime,
                    endTime: nextClass.endTime
                } : null;
            } catch (error) {
                console.error('Error finding relevant course:', error);
                return null;
            }
        }

        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            document.getElementById('lastUpdatedTime').textContent = now.toLocaleString();
            document.getElementById('lastUpdatedInfo').classList.remove('d-none');
        }

        async function loadUsers() {
            const usersRef = database.ref('users');
            usersRef.on('value', (snapshot) => {
                const users = snapshot.val();
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = '<option value="">Select Entry Number</option>';

                for (const entryNumber in users) {
                    const option = document.createElement('option');
                    option.value = entryNumber;
                    option.textContent = `${entryNumber} - ${users[entryNumber].name}`;
                    userSelect.appendChild(option);
                }

                const lastUser = getCookie('lastUser');
                if (lastUser && users[lastUser]) {
                    userSelect.value = lastUser;
                    loadUserData(lastUser);
                }
            });
        }

        async function loadUserData(entryNumber) {
            if (!entryNumber) return;

            try {
                const userData = (await database.ref(`users/${entryNumber}`).once('value')).val();
                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userCourses').textContent = userData.registered_courses.join(', ');
                document.getElementById('userInfo').classList.remove('d-none');

                const courseSelects = ['attendanceCourse', 'tagCourse', 'viewCourse'];
                const relevantCourse = await findRelevantCourse(entryNumber);

                courseSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Select Course</option>';

                    userData.registered_courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course;
                        option.textContent = course;
                        select.appendChild(option);
                    });
                });

                if (relevantCourse) {
                    document.getElementById('attendanceCourse').value = relevantCourse.code;
                    document.getElementById('startTime').value = relevantCourse.startTime;
                    document.getElementById('endTime').value = relevantCourse.endTime;

                    document.getElementById('tagCourse').value = relevantCourse.code;
                    document.getElementById('tagStartTime').value = relevantCourse.startTime;
                    document.getElementById('tagEndTime').value = relevantCourse.endTime;
                } else {
                    document.getElementById('attendanceCourse').value = '';
                    document.getElementById('startTime').value = '';
                    document.getElementById('endTime').value = '';

                    document.getElementById('tagCourse').value = '';
                    document.getElementById('tagStartTime').value = '';
                    document.getElementById('tagEndTime').value = '';
                }

                const today = new Date().toISOString().split('T')[0];
                document.getElementById('attendanceDate').value = today;
                document.getElementById('tagDate').value = today;
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        document.getElementById('userSelect').addEventListener('change', (e) => {
            const entryNumber = e.target.value;
            if (entryNumber) {
                setCookie('lastUser', entryNumber, 30);
                loadUserData(entryNumber);
            } else {
                document.getElementById('userInfo').classList.add('d-none');
            }
        });

        document.querySelectorAll('input[name="action"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.getElementById('markAttendanceForm').classList.add('d-none');
                document.getElementById('tagClassForm').classList.add('d-none');
                document.getElementById('viewAttendanceForm').classList.add('d-none');
                document.getElementById(`${e.target.value}Form`).classList.remove('d-none');
            });
        });

        document.getElementById('tagType').addEventListener('change', (e) => {
            const remarkDiv = document.getElementById('remarkDiv');
            if (e.target.value === 'other') {
                remarkDiv.classList.remove('d-none');
                document.getElementById('remark').required = true;
            } else {
                remarkDiv.classList.add('d-none');
                document.getElementById('remark').required = false;
            }
        });

        async function isClassScheduled(courseCode, date, startTime, endTime) {
            try {
                const coursesSnapshot = await database.ref('courses').once('value');
                const courses = coursesSnapshot.val() || {};
                const courseSchedule = courses[courseCode]?.schedule || [];

                // Get day of week (0-6) from date
                const day = new Date(date).getDay();

                // Check if there's a matching schedule
                const scheduledClass = courseSchedule.find(schedule =>
                    schedule.day === day &&
                    schedule.startTime === startTime &&
                    schedule.endTime === endTime
                );

                return !!scheduledClass;
            } catch (error) {
                console.error('Error checking class schedule:', error);
                return false;
            }
        }

        async function doesClassExist(date, courseCode, timeSlot) {
            try {
                const classSnapshot = await database.ref(`classes/${date}/${courseCode}/${timeSlot}`).once('value');
                return classSnapshot.exists();
            } catch (error) {
                console.error('Error checking class existence:', error);
                return false;
            }
        }

        // Replace the existing attendanceForm submit event listener with this updated version
        document.getElementById('attendanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const entryNumber = document.getElementById('userSelect').value;
            const courseCode = document.getElementById('attendanceCourse').value;
            const date = document.getElementById('attendanceDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const attendanceType = document.getElementById('attendanceType').value;
            const timeSlot = `${startTime}-${endTime}`;

            try {
                if (!entryNumber) {
                    alert('Please select a user');
                    return;
                }

                // Check if attendance is allowed
                const allowed = await isAttendanceAllowed(date, courseCode, timeSlot);
                if (!allowed) {
                    alert('Cannot mark attendance for this class as it is either cancelled or marked as attendance not taken');
                    return;
                }
                const classExists = await doesClassExist(date, courseCode, timeSlot);

                let shouldProceed = true;
                if (!classExists) {
                    const isScheduled = await isClassScheduled(courseCode, date, startTime, endTime);
                    if (!isScheduled) {
                        shouldProceed = confirm(
                            'Warning: This class is not in the regular schedule. ' +
                            'Are you sure you want to mark attendance for this out-of-schedule class?'
                        );
                    }
                }

                if (!shouldProceed) {
                    return;
                }

                const attendancePath = `attendance/${date}/${courseCode}/${timeSlot}/${entryNumber}`;
                const classPath = `classes/${date}/${courseCode}/${timeSlot}`;

                const updates = {};
                updates[attendancePath] = {
                    entry_number: entryNumber,
                    course_code: courseCode,
                    date: date,
                    startTime: startTime,
                    endTime: endTime,
                    attendance_type: attendanceType,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                if (!classExists) {
                    const isScheduled = await isClassScheduled(courseCode, date, startTime, endTime);
                    await database.ref(classPath).set({
                        tag: isScheduled ? 'normal' : 'extra', // Mark unscheduled classes as extra
                        startTime: startTime,
                        endTime: endTime,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }

                await database.ref().update(updates);
                alert('Attendance marked successfully');
                updateLastUpdatedTime();
            } catch (error) {
                alert('Error marking attendance: ' + error.message);
            }
        });


        document.getElementById('tagForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const courseCode = document.getElementById('tagCourse').value;
            const date = document.getElementById('tagDate').value;
            const startTime = document.getElementById('tagStartTime').value;
            const endTime = document.getElementById('tagEndTime').value;
            const timeSlot = `${startTime}-${endTime}`;
            const tag = document.getElementById('tagType').value;
            const remark = document.getElementById('remark').value;

            try {
                const classPath = `classes/${date}/${courseCode}/${timeSlot}`;
                const classData = {
                    course_code: courseCode,
                    date: date,
                    startTime: startTime,
                    endTime: endTime,
                    tag: tag,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                if (tag === 'other') {
                    classData.remark = remark;
                }

                await database.ref(classPath).set(classData);

                // If class is tagged as cancelled or attendance_not_taken, remove existing attendance
                if (tag === 'cancelled' || tag === 'attendance_not_taken') {
                    await removeExistingAttendance(date, courseCode, timeSlot);
                }

                alert('Class tagged successfully');
                updateLastUpdatedTime();
            } catch (error) {
                alert('Error tagging class: ' + error.message);
            }
        });

        // Handle attendance viewing
        document.getElementById('viewCourse').addEventListener('change', async (e) => {
            e.preventDefault();
            const entryNumber = document.getElementById('userSelect').value;
            const courseCode = document.getElementById('viewCourse').value;
            if (entryNumber && courseCode) {
                await fetchAndDisplayAttendance(entryNumber, courseCode);
            }
        });
        function roundToNearestThirtyMinutes(timeInput) {
            timeInput.addEventListener('change', (e) => {
                const time = e.target.value;
                if (time) {
                    const [hours, minutes] = time.split(':');
                    const roundedMinutes = Math.round(minutes / 30) * 30;
                    const adjustedHours = parseInt(hours) + Math.floor(roundedMinutes / 60);
                    const finalMinutes = roundedMinutes % 60;

                    e.target.value = `${String(adjustedHours).padStart(2, '0')}:${String(finalMinutes).padStart(2, '0')}`;
                }
            });
        }
        document.getElementById('attendanceCourse').addEventListener('change', async (e) => {
            const courseCode = e.target.value;
            const entryNumber = document.getElementById('userSelect').value;
            if (courseCode && entryNumber) {
                const date = document.getElementById('attendanceDate').value;
                const day = new Date(date).getDay();
                const coursesSnapshot = await database.ref('courses').once('value');
                const courses = coursesSnapshot.val() || {};
                const courseSchedule = courses[courseCode]?.schedule || [];
                const relevantSchedule = courseSchedule.find(schedule => schedule.day === day);
                if (relevantSchedule) {
                    document.getElementById('startTime').value = relevantSchedule.startTime;
                    document.getElementById('endTime').value = relevantSchedule.endTime;
                } else {
                    document.getElementById('startTime').value = '';
                    document.getElementById('endTime').value = '';
                }
            }
        });
        document.getElementById('attendanceDate').addEventListener('input', async (e) => {
            console.log("HI");
            const date = e.target.value;
            const courseCode = document.getElementById('attendanceCourse').value;
            const day = new Date(date).getDay();
            if (courseCode) {
                const coursesSnapshot = await database.ref('courses').once('value');
                const courses = coursesSnapshot.val() || {};
                const courseSchedule = courses[courseCode]?.schedule || [];
                const relevantSchedule = courseSchedule.find(schedule => schedule.day === day);
                console.log(relevantSchedule);
                if (relevantSchedule) {
                    document.getElementById('startTime').value = relevantSchedule.startTime;
                    document.getElementById('endTime').value = relevantSchedule.endTime;
                } else {
                    document.getElementById('startTime').value = '';
                    document.getElementById('endTime').value = '';
                }
            }
        });
        document.getElementById('tagCourse').addEventListener('change', async (e) => {
            const courseCode = e.target.value;
            const entryNumber = document.getElementById('userSelect').value;
            if (courseCode && entryNumber) {
                const date = document.getElementById('tagDate').value;
                const day = new Date(date).getDay();
                const coursesSnapshot = await database.ref('courses').once('value');
                const courses = coursesSnapshot.val() || {};
                const courseSchedule = courses[courseCode]?.schedule || [];
                const relevantSchedule = courseSchedule.find(schedule => schedule.day === day);
                if (relevantSchedule) {
                    document.getElementById('tagStartTime').value = relevantSchedule.startTime;
                    document.getElementById('tagEndTime').value = relevantSchedule.endTime;
                } else {
                    document.getElementById('tagStartTime').value = '';
                    document.getElementById('tagEndTime').value = '';
                }
            }
        });
        document.getElementById('tagDate').addEventListener('input', async (e) => {
            const date = e.target.value;
            const courseCode = document.getElementById('tagCourse').value;
            const day = new Date(date).getDay();
            if (courseCode) {
                const coursesSnapshot = await database.ref('courses').once('value');
                const courses = coursesSnapshot.val() || {};
                const courseSchedule = courses[courseCode]?.schedule || [];
                const relevantSchedule = courseSchedule.find(schedule => schedule.day === day);
                if (relevantSchedule) {
                    document.getElementById('tagStartTime').value = relevantSchedule.startTime;
                    document.getElementById('tagEndTime').value = relevantSchedule.endTime;
                } else {
                    document.getElementById('tagStartTime').value = '';
                    document.getElementById('tagEndTime').value = '';
                }
            }
        });

        document.getElementById('markAttendance').addEventListener('click', async () => {
            const entryNumber = document.getElementById('userSelect').value;
            if (entryNumber) {
                await loadUserData(entryNumber);
            }
        });

        document.getElementById('tagClass').addEventListener('click', async () => {
            const entryNumber = document.getElementById('userSelect').value;
            if (entryNumber) {
                await loadUserData(entryNumber);
            }
        });

        let currentChart = null;
        async function fetchAndDisplayAttendance(entryNumber, courseCode) {
            try {
                // Get attendance records
                const attendanceSnapshot = await database.ref('attendance').once('value');
                const attendance = attendanceSnapshot.val() || {};

                // Get class records
                const classesSnapshot = await database.ref('classes').once('value');
                const classes = classesSnapshot.val() || {};

                // Get course schedule
                const coursesSnapshot = await database.ref('courses').once('value');
                const courses = coursesSnapshot.val() || {};
                const courseSchedule = courses[courseCode]?.schedule || [];

                function formatDate(dateStr) {
                    const date = new Date(dateStr);
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return `${date.getDate()} ${months[date.getMonth()]} (${days[date.getDay()]})`;
                }

                function getRowStyle(classStatus, attendance) {
                    if (classStatus === 'cancelled') {
                        return 'background-color: #ffebcc !important;';
                    }
                    if (classStatus === 'attendance_not_taken') {
                        return 'background-color: #e0e0e0 !important;';
                    }
                    if (attendance === 'Not Marked') {
                        return 'background-color: #ffe6e6 !important;';
                    }
                    if (classStatus === 'extra' || classStatus === 'online') {
                        return 'background-color: #e6f3ff !important;';
                    }
                    return '';
                }

                const attendedClasses = [];
                Object.keys(attendance).forEach(date => {
                    if (attendance[date]?.[courseCode]) {
                        Object.entries(attendance[date][courseCode]).forEach(([timeSlot, attendanceData]) => {
                            if (attendanceData[entryNumber]) {
                                const record = attendanceData[entryNumber];
                                attendedClasses.push({
                                    date,
                                    timeSlot,
                                    startTime: record.startTime,
                                    endTime: record.endTime,
                                    attendance_type: record.attendance_type
                                });
                            }
                        });
                    }
                });

                const classRecords = [];
                Object.keys(classes).forEach(date => {
                    if (classes[date]?.[courseCode]) {
                        Object.entries(classes[date][courseCode]).forEach(([timeSlot, record]) => {
                            classRecords.push({
                                date,
                                timeSlot,
                                startTime: record.startTime,
                                endTime: record.endTime,
                                tag: record.tag,
                                remark: record.remark || ''
                            });
                        });
                    }
                });

                attendedClasses.sort((a, b) => {
                    const dateCompare = b.date.localeCompare(a.date);
                    return dateCompare !== 0 ? dateCompare : b.startTime.localeCompare(a.startTime);
                });

                classRecords.sort((a, b) => {
                    const dateCompare = b.date.localeCompare(a.date);
                    return dateCompare !== 0 ? dateCompare : b.startTime.localeCompare(a.startTime);
                });

                const totalClasses = classRecords.filter(record =>
                    record.tag === 'normal' || record.tag === 'online' || record.tag === 'extra' || record.tag === 'attendance_not_taken' || record.tag === 'other'
                ).length;

                const validAttendance = attendedClasses.filter(record =>
                    record.attendance_type === 'true'
                ).length;

                const proxyAttendance = attendedClasses.filter(record =>
                    record.attendance_type === 'proxy'
                ).length;

                const attendanceNotTaken = classRecords.filter(record =>
                    record.tag === 'attendance_not_taken'
                ).length;

                const missedClasses = totalClasses - (validAttendance + proxyAttendance + attendanceNotTaken);
                const attendancePercentage = totalClasses > 0 ?
                    (((validAttendance + proxyAttendance + attendanceNotTaken) / totalClasses) * 100).toFixed(2) : 0;
                // Create or update pie chart
                const ctx = document.getElementById('attendanceChart').getContext('2d');

                // Destroy existing chart if it exists
                if (currentChart instanceof Chart) {
                    currentChart.destroy();
                }
                const options = {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        textInside: {
                            text: `${attendancePercentage}%`,
                            color: 'black',
                            fontSize: 24
                        }
                    },
                    layout: {
                        padding: 5
                    },
                    cutout: '80%',
                };
                document.getElementById('pie_container').classList.remove('d-none');
                currentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Present', 'NoAtt', 'Missed'],
                        datasets: [{
                            data: [validAttendance + proxyAttendance, attendanceNotTaken, missedClasses],
                            backgroundColor: [
                                '#198754', // Present - Green
                                '#6c757d', // NoAtt - Gray
                                '#dc3545'  // Missed - Red
                            ],
                            borderWidth: 2,
                            borderRadius: 100,
                        }]
                    },
                    options: options
                });
                Chart.register({
                    id: 'textInside',
                    afterDatasetsDraw: function (chart, args, pluginOptions) {
                        const {ctx, data} = chart;
                        const text = pluginOptions.text;
                        ctx.save();
                        const x = chart.getDatasetMeta(0).data[0].x;
                        const y = chart.getDatasetMeta(0).data[0].y;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = `bold 130% sans-serif`;
                        ctx.fillText(text, x, y);
                    }
                });


                let resultsHTML = `
            <div class="table-responsive">
                <table class="table table-bordered">
                    <colgroup>
                        <col style="width: 50%;">
                        <col style="width: 50%;">
                    </colgroup>
                    <thead class="position-sticky top-0 bg-white">
                        <tr>
                            <th scope="col" class="align-middle">Date & Time</th>
                            <th scope="col" class="align-middle">Status</th>
                        </tr>
                    </thead>
                    <tbody>`;

                const allSlots = new Map();

                classRecords.forEach(record => {
                    const key = `${record.date}-${record.timeSlot}`;
                    allSlots.set(key, {
                        date: record.date,
                        timeSlot: record.timeSlot,
                        startTime: record.startTime,
                        endTime: record.endTime,
                        classStatus: record.tag === 'other' ? `${record.tag} (${record.remark})` : record.tag,
                        attendance: 'Not Marked'
                    });
                });

                attendedClasses.forEach(record => {
                    const key = `${record.date}-${record.timeSlot}`;
                    if (!allSlots.has(key)) {
                        allSlots.set(key, {
                            date: record.date,
                            timeSlot: record.timeSlot,
                            startTime: record.startTime,
                            endTime: record.endTime,
                            classStatus: 'normal',
                            attendance: 'Not Marked'
                        });
                    }
                    const slot = allSlots.get(key);
                    slot.attendance = record.attendance_type === 'true' ? 'Present' : 'Proxy';
                });

                const allSlotsArray = Array.from(allSlots.values())
                    .sort((a, b) => {
                        const dateCompare = b.date.localeCompare(a.date);
                        return dateCompare !== 0 ? dateCompare : b.startTime.localeCompare(a.startTime);
                    });

                allSlotsArray.forEach(slot => {
                    const rowStyle = getRowStyle(slot.classStatus, slot.attendance);
                    resultsHTML += `
                        <tr>
                            <td style="${rowStyle}">
                                <div class="fw-bold">${formatDate(slot.date)}</div>
                                <div class="text-muted small">${slot.startTime} - ${slot.endTime}</div>
                            </td>
                            <td style="${rowStyle}">
                                <div>${slot.classStatus}</div>
                                <div class="mt-1">
                                    <span class="badge ${
                                        slot.attendance === 'Present' ? 'bg-success' :
                                        slot.attendance === 'Proxy' ? 'bg-warning' :
                                        slot.classStatus === 'attendance_not_taken' ? 'bg-secondary' :
                                        'bg-danger'
                                    }">${slot.attendance}</span>
                                </div>
                            </td>
                        </tr>`;
                });

                resultsHTML += `
                            </tbody>
                        </table>
                    </div>`;

                document.getElementById('attendanceResults').innerHTML = resultsHTML;
                updateLastUpdatedTime();
            } catch (error) {
                alert('Error viewing attendance: ' + error.message);
                document.getElementById('attendanceResults').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading attendance data: ${error.message}
                    </div>`;
            }
        }

        // Event listener
        document.getElementById('viewAttendance').addEventListener('click', async (e) => {
            document.getElementById('attendanceResults').innerHTML = "";
            // hide the pie chart
            document.getElementById('pie_container').classList.add('d-none');
            const entryNumber = document.getElementById('userSelect').value;
            const courseCode = document.getElementById('viewCourse').value;
            if (entryNumber && courseCode) {
                await fetchAndDisplayAttendance(entryNumber, courseCode);
            }
        });

        // Apply to all time inputs
        ['startTime', 'endTime', 'tagStartTime', 'tagEndTime'].forEach(id => {
            const timeInput = document.getElementById(id);
            roundToNearestThirtyMinutes(timeInput);
        });


        // Initialize the application
        loadUsers();

    </script>
</body>
</html>
